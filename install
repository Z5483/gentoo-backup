#!/bin/sh

if [ "$EUID" -ne 0 ]; then
	echo "Please run as root."
	exit 0
fi

cp -v $(pwd -P)/etc/fstab /etc/fstab
cp -v $(pwd -P)/etc/sysctl.conf /etc/sysctl.conf
cp -v $(pwd -P)/usr/share/consolefonts/* /usr/share/consolefonts/
cp -rv $(pwd -P)/usr/share/fonts/* /usr/share/fonts/

if (qlist -I | grep portage) > /dev/null; then
	cp -rv $(pwd -P)/etc/portage/* /etc/portage/
fi

if (qlist -I | grep ccache) > /dev/null; then
	if [[ ! -d /var/tmp/ccahe ]]; then
		mkdir -p /var/tmp/ccache
	fi

	cp -v $(pwd -P)/var/tmp/ccache/ccache.conf /var/tmp/ccache/ccache.conf
fi

if (qlist -I | grep genkernel) > /dev/null; then
	cp -v $(pwd -P)/etc/genkernel.conf /etc/genkernel.conf
fi

if (qlist -I | grep gentoo-sources) > /dev/null; then
	cp -v $(pwd -P)/usr/src/linux/.config /usr/src/linux/.config
fi

if (qlist -I | grep layman) > /dev/null; then
	if [[ ! -d /etc/layman ]]; then
		mkdir -p /etc/layman
	fi

	cp -v $(pwd -P)/etc/layman/layman.cfg /etc/layman/layman.cfg
fi

if (qlist -I | grep libvirt) > /dev/null; then
	if [[ ! -d /etc/libvirt ]]; then
		mkdir -p /etc/libvirt
	fi

	cp -v $(pwd -P)/etc/libvirt/libvirtd.conf /etc/libvirt/libvirtd.conf
fi

if (qlist -I | grep systemd) > /dev/null; then
	if [[ ! -d /etc/systemd ]]; then
		mkdir -p /etc/systemd
	fi

	cp -rv $(pwd -P)/etc/systemd/* /etc/systemd/

	if [[ ! -d /etc/udev ]]; then
		mkdir -p /etc/udev
	fi

	cp -rv $(pwd -P)/etc/udev/* /etc/udev/

	cp -rv $(pwd -P)/boot/loader/* /boot/loader/

	cp -v $(pwd -P)/etc/vconsole.conf /etc/vconsole.conf
fi

if (qlist -I | grep tmux) > /dev/null; then
	for terminfo in $(ls "$(pwd -P)/etc/terminfo"); do
		tic -sx $(pwd -P)/etc/terminfo/$terminfo
	done
fi

if (qlist -I | grep xorg-server) > /dev/null; then
	if [[ ! -d /etc/X11 ]]; then
		mkdir -p /etc/X11
	fi

	cp -rv $(pwd -P)/etc/X11/* /etc/X11/

	if [[ ! -d /usr/share/cursors/xorg-x11 ]]; then
		mkdir -p /usr/share/cursors/xorg-x11
	fi

	cp -rv $(pwd -P)/usr/share/cursors/xorg-x11/* /usr/share/cursors/xorg-x11/

	if [[ ! -d /etc/fonts ]]; then
		mkdir -p /etc/fonts
	fi

	cp -v $(pwd -P)/etc/fonts/fonts.conf /etc/fonts/fonts.conf
fi

if ! (qlist -I | grep genkernel) > /dev/null; then
	if [[ ! -d /usr/src/initramfs/{bin,dev,etc,lib,lib64,mnt/root,proc,root,sbin,sys} ]]; then
		mkdir -p /usr/src/initramfs/{bin,dev,etc,lib,lib64,mnt/root,proc,root,sbin,sys}
	fi

	cp -av /dev/{null,console,tty,sda1} /usr/src/initramfs/dev/
	cp -rv $(pwd -P)/usr/src/initramfs/* /usr/src/initramfs
	echo 'entering: /usr/src/initramfs'
	find . -print0 | cpio --null --create --verbose --format=newc | gzip --best > ./custom-initramfs.cpio.gz
fi
